<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TitliAI Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gradient-start': '#e3e7ef',
                        'gradient-middle': '#d1e3f8',
                        'gradient-end': '#b6c6e3'
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #e3e7ef 0%, #d1e3f8 50%, #b6c6e3 100%);
        }
        .header-gradient {
            background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%);
        }
        .tab-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-900 font-sans">
    <!-- Login Form -->
    <div id="loginForm" class="flex items-center justify-center min-h-screen">
        <div class="glass-effect rounded-xl shadow-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">ü¶ã</div>
                <h1 class="text-2xl font-bold text-gray-900">TitliAI Admin Access</h1>
                <p class="text-gray-600 mt-2">Enter admin password to continue</p>
            </div>
            
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <input
                        type="password"
                        id="adminPassword"
                        placeholder="Admin Password"
                        class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    />
                </div>
                
                <div id="loginError" class="text-red-600 text-sm text-center hidden"></div>
                
                <button
                    type="submit"
                    class="w-full tab-gradient text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition-all"
                >
                    Access Admin Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
        <!-- Header -->
        <div class="header-gradient text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold">ü¶ã TitliAI Admin Dashboard</h1>
                        <p class="text-blue-100 mt-1">Manage users, enrollments, payments</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button
                            onclick="loadData()"
                            class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors"
                        >
                            üîÑ Refresh
                        </button>
                        <button
                            onclick="logout()"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"
                        >
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Tabs -->
            <div class="glass-effect rounded-xl shadow-lg p-1 mb-8">
                <div class="flex space-x-1">
                    <button onclick="switchTab('analytics')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="analytics">
                        üìä Analytics
                    </button>
                    <button onclick="switchTab('users')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="users">
                        üë• Users
                    </button>
                    <button onclick="switchTab('enrollments')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="enrollments">
                        üéì Enrollments
                    </button>
                    <button onclick="switchTab('payments')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="payments">
                        üí∞ Payments
                    </button>
                                         <button onclick="switchTab('workshops')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="workshops">
                         üìö Workshops
                     </button>
                     <button onclick="switchTab('live-sessions')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="live-sessions">
                         üé• Live Sessions
                     </button>
                     <button onclick="switchTab('upload-workshop')" class="tab-button flex-1 py-3 px-4 rounded-lg font-medium transition-all" data-tab="upload-workshop">
                         üì§ Upload Workshop
                     </button>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Search..."
                            onkeyup="filterData()"
                            class="w-full px-4 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                    <div class="md:w-48">
                        <select
                            id="statusFilter"
                            onchange="filterData()"
                            class="w-full px-4 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="glass-effect rounded-xl shadow-lg p-6">
                <div id="loadingSpinner" class="flex items-center justify-center py-12 hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    <span class="ml-3 text-gray-600">Loading data...</span>
                </div>
                
                <div id="contentArea">
                    <!-- Content will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - will be loaded dynamically
        let firebaseConfig = null;
        let db = null;

        // Function to load Firebase configuration
        async function loadFirebaseConfig() {
            try {
                console.log('üîç Loading Firebase configuration...');
                
                // Use direct Firebase config (no server needed)
                firebaseConfig = {
                    "apiKey": "AIzaSyBXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                    "authDomain": "mumee-ai.firebaseapp.com",
                    "projectId": "mumee-ai",
                    "storageBucket": "mumee-ai.appspot.com",
                    "messagingSenderId": "123456789012",
                    "appId": "1:123456789012:web:abcdefghijklmnop",
                    "databaseURL": "https://mumee-ai-default-rtdb.firebaseio.com"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('‚úÖ Firebase initialized with config:', firebaseConfig);
            } catch (error) {
                console.error('‚ùå Error initializing Firebase:', error);
                throw error;
            }
        }

        // Admin password
        const ADMIN_PASSWORD = 'titliAI2025!';
        let currentTab = 'analytics';
        let allData = {
            users: [],
            enrollments: [],
            payments: [],
            workshops: []
        };

        // Initialize Firebase and check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Load Firebase configuration first
            await loadFirebaseConfig();
            
            // Then check authentication
            if (sessionStorage.getItem('adminAuthenticated') === 'true') {
                showDashboard();
            }
        });

        // Login form handler
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                await showDashboard();
                errorDiv.classList.add('hidden');
            } else {
                errorDiv.textContent = 'Invalid password';
                errorDiv.classList.remove('hidden');
            }
        });

        async function showDashboard() {
            // Ensure Firebase is initialized
            if (!db) {
                await loadFirebaseConfig();
            }
            
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadData();
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-gradient', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-white/50');
            });
            
            document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-gradient', 'text-white');
            document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-600', 'hover:bg-white/50');
            
            renderContent();
        }

        async function loadData() {
            showLoading(true);
            
            try {
                console.log('üîç Loading data for tab:', currentTab);
                console.log('üîç Firebase config:', firebaseConfig);
                console.log('üîç Firestore instance:', db);
                
                // Test Firebase connection first
                console.log('üîç Testing Firebase connection...');
                const testRef = db.collection('test');
                await testRef.get();
                console.log('‚úÖ Firebase connection successful');
                
                // Load all data in parallel
                console.log('üîç Loading collections...');
                const [usersSnapshot, enrollmentsSnapshot, paymentsSnapshot, workshopsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('enrollments').get(),
                    db.collection('payments').get(),
                    db.collection('workshops').get()
                ]);

                console.log('üìä Collections loaded:', {
                    users: usersSnapshot.docs.length,
                    enrollments: enrollmentsSnapshot.docs.length,
                    payments: paymentsSnapshot.docs.length,
                    workshops: workshopsSnapshot.docs.length
                });

                allData.users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allData.enrollments = enrollmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allData.payments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allData.workshops = workshopsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // If no data found, show sample data for testing
                if (allData.users.length === 0 && allData.enrollments.length === 0 && allData.payments.length === 0 && allData.workshops.length === 0) {
                    console.log('üìù No data found, showing sample data for testing');
                    allData.users = [
                        { id: 'sample-user-1', displayName: 'John Doe', email: 'john@example.com', createdAt: new Date(), geolocation: { countryName: 'India' }, stats: { totalEnrollments: 2, completedWorkshops: 1, totalSpent: 5000 } },
                        { id: 'sample-user-2', displayName: 'Jane Smith', email: 'jane@example.com', createdAt: new Date(), geolocation: { countryName: 'USA' }, stats: { totalEnrollments: 1, completedWorkshops: 0, totalSpent: 2500 } }
                    ];
                    allData.workshops = [
                        { id: 'sample-workshop-1', title: 'AI Foundation Course', slug: 'ai-foundation', level: 'foundation', price: 2500, status: 'active', duration: 20, createdAt: new Date() },
                        { id: 'sample-workshop-2', title: 'Advanced AI Workshop', slug: 'advanced-ai', level: 'advanced', price: 5000, status: 'active', duration: 30, createdAt: new Date() }
                    ];
                    allData.enrollments = [
                        { id: 'sample-enrollment-1', userId: 'sample-user-1', workshopId: 'sample-workshop-1', status: 'active', progress: { percentageComplete: 75 }, enrolledAt: new Date(), payment: { amount: 2500, status: 'completed' } },
                        { id: 'sample-enrollment-2', userId: 'sample-user-2', workshopId: 'sample-workshop-2', status: 'pending', progress: { percentageComplete: 0 }, enrolledAt: new Date(), payment: { amount: 5000, status: 'pending' } }
                    ];
                    allData.payments = [
                        { id: 'sample-payment-1', userId: 'sample-user-1', workshopId: 'sample-workshop-1', amount: 2500, status: 'completed', paymentMethod: 'razorpay', createdAt: new Date() },
                        { id: 'sample-payment-2', userId: 'sample-user-2', workshopId: 'sample-workshop-2', amount: 5000, status: 'pending', paymentMethod: 'razorpay', createdAt: new Date() }
                    ];
                }

                console.log('‚úÖ Data loaded successfully');
                renderContent();
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                console.error('‚ùå Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                showError(`Error loading data: ${error.message}. This might be due to Firestore security rules or missing collections. Check the browser console for more details.`);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const content = document.getElementById('contentArea');
            
            if (show) {
                spinner.classList.remove('hidden');
                content.classList.add('hidden');
            } else {
                spinner.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }

        function showError(message) {
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">‚ùå</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Error</h3>
                    <p class="text-gray-600">${message}</p>
                </div>
            `;
        }

        function filterData() {
            renderContent();
        }

        function renderContent() {
            const content = document.getElementById('contentArea');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let data = allData[currentTab] || [];
            
            // Apply filters
            if (searchTerm) {
                data = data.filter(item => 
                    JSON.stringify(item).toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter !== 'all') {
                data = data.filter(item => item.status === statusFilter);
            }

            switch (currentTab) {
                case 'analytics':
                    content.innerHTML = renderAnalytics();
                    break;
                case 'users':
                    content.innerHTML = renderUsersTable(data);
                    break;
                case 'enrollments':
                    content.innerHTML = renderEnrollmentsTable(data);
                    break;
                case 'payments':
                    content.innerHTML = renderPaymentsTable(data);
                    break;
                                 case 'workshops':
                     content.innerHTML = renderWorkshopsTable(data);
                     break;
                 case 'live-sessions':
                     content.innerHTML = renderLiveSessionsTab();
                     break;
                 case 'upload-workshop':
                     content.innerHTML = renderUploadWorkshopTab();
                     break;
            }
        }

        function renderAnalytics() {
            const users = allData.users.length;
            const enrollments = allData.enrollments.length;
            const payments = allData.payments.length;
            const activeWorkshops = allData.workshops.filter(w => w.status === 'active').length;
            
            const totalRevenue = allData.payments.reduce((sum, p) => sum + (p.amount || 0), 0);

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Users</p>
                                <p class="text-2xl font-semibold text-gray-900">${users}</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Enrollments</p>
                                <p class="text-2xl font-semibold text-gray-900">${enrollments}</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                                <p class="text-2xl font-semibold text-gray-900">‚Çπ${totalRevenue.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    <div class="glass-effect rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-orange-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Active Workshops</p>
                                <p class="text-2xl font-semibold text-gray-900">${activeWorkshops}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUsersTable(users) {
            if (users.length === 0) {
                return renderEmptyState();
            }

            const rows = users.map(user => `
                <tr class="hover:bg-blue-50/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full tab-gradient flex items-center justify-center text-white font-semibold">
                                ${(user.displayName || user.email || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.displayName || 'N/A'}</div>
                                <div class="text-sm text-gray-500">ID: ${user.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.geolocation?.countryName || 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(user.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="text-xs">
                            <div>Enrollments: ${user.stats?.totalEnrollments || 0}</div>
                            <div>Completed: ${user.stats?.completedWorkshops || 0}</div>
                            <div>Spent: ‚Çπ${(user.stats?.totalSpent || 0).toLocaleString()}</div>
                        </div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full glass-effect border border-blue-100 rounded-lg shadow-lg">
                        <thead class="header-gradient text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Joined</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Stats</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-blue-100">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderEnrollmentsTable(enrollments) {
            if (enrollments.length === 0) {
                return renderEmptyState();
            }

            const rows = enrollments.map(enrollment => {
                // Find user details for this enrollment
                const user = allData.users.find(u => u.id === enrollment.userId);
                const userName = user ? (user.displayName || user.email || 'Unknown User') : 'Unknown User';
                const userEmail = user ? user.email : 'N/A';
                
                // Find workshop details for this enrollment
                const workshop = allData.workshops.find(w => w.id === enrollment.workshopId);
                const workshopName = workshop ? workshop.title : 'Unknown Workshop';
                
                return `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${enrollment.id.substring(0, 8)}...
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-full tab-gradient flex items-center justify-center text-white font-semibold text-xs">
                                    ${userName.charAt(0).toUpperCase()}
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900">${userName}</div>
                                    <div class="text-xs text-gray-500">${userEmail}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="text-sm font-medium text-gray-900">${workshopName}</div>
                            <div class="text-xs text-gray-500">${enrollment.workshopId.substring(0, 8)}...</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(enrollment.status)}">
                                ${enrollment.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="tab-gradient h-2 rounded-full" style="width: ${enrollment.progress?.percentageComplete || 0}%"></div>
                            </div>
                            <span class="text-xs text-gray-500">${enrollment.progress?.percentageComplete || 0}%</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatDate(enrollment.enrolledAt)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="text-xs">
                                <div>‚Çπ${(enrollment.payment?.amount || 0).toLocaleString()}</div>
                                <div class="inline-flex px-1 py-0.5 text-xs font-semibold rounded ${getStatusColor(enrollment.payment?.status)}">
                                    ${enrollment.payment?.status || 'N/A'}
                                </div>
                            </div>
                        </td>
                                                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 bg-red-100 border-l-4 border-red-500 min-w-[200px]" style="border: 3px solid red;">
                             <div class="text-xs">
                                 <div class="font-bold text-yellow-800 mb-1">üîß ACTIONS COLUMN</div>
                                 <div>Workshop: ${workshopName}</div>
                                 <div>Live: ${workshop?.isLiveSession ? 'Yes' : 'No'}</div>
                                 <div>Date: ${workshop?.scheduledDate || 'None'}</div>
                                 ${workshop && workshop.isLiveSession ? 
                                     (workshop.scheduledDate ? 
                                         `${enrollment.notifications?.liveSessionSent ? 
                                             `<div class="text-green-600 font-medium mb-1">‚úÖ Email Sent: ${formatDate(enrollment.notifications.liveSessionSent)}</div>` :
                                             `<button onclick="sendLiveSessionNotification('${enrollment.id}', '${userEmail}', '${userName}', '${workshop.id}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors mt-1 w-full" title="Send Live Session Reminder">üìß Send Reminder</button>`
                                         }` :
                                         `<div class="space-y-1 mt-1"><div class="text-xs text-orange-600 font-medium">Live Session - No Date Set</div><button onclick="setWorkshopDate('${workshop.id}')" class="px-2 py-1 bg-orange-500 text-white text-xs rounded hover:bg-orange-600 transition-colors w-full" title="Set Scheduled Date">üìÖ Set Date</button></div>`
                                     ) :
                                     `<div class="text-xs text-gray-400 mt-1">${!workshop ? 'No workshop data' : 'Not a live session'}</div>`
                                 }
                             </div>
                         </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full glass-effect border border-blue-100 rounded-lg shadow-lg">
                        <thead class="header-gradient text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Enrollment ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Workshop</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Progress</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Enrolled</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Payment</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider bg-red-600 text-white" style="border: 2px solid red;">üîß ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-blue-100">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPaymentsTable(payments) {
            if (payments.length === 0) {
                return renderEmptyState();
            }

            const rows = payments.map(payment => {
                // Find user details for this payment
                const user = allData.users.find(u => u.id === payment.userId);
                const userName = user ? (user.displayName || user.email || 'Unknown User') : 'Unknown User';
                const userEmail = user ? user.email : 'N/A';
                
                // Find workshop details for this payment
                const workshop = allData.workshops.find(w => w.id === payment.workshopId);
                const workshopName = workshop ? workshop.title : 'Unknown Workshop';
                
                return `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${payment.id.substring(0, 8)}...
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-full tab-gradient flex items-center justify-center text-white font-semibold text-xs">
                                    ${userName.charAt(0).toUpperCase()}
                                </div>
                                <div class="ml-3">
                                    <div class="text-sm font-medium text-gray-900">${userName}</div>
                                    <div class="text-xs text-gray-500">${userEmail}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="text-sm font-medium text-gray-900">${workshopName}</div>
                            <div class="text-xs text-gray-500">${payment.workshopId.substring(0, 8)}...</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div>
                                <div class="font-semibold">‚Çπ${(payment.amount || 0).toLocaleString()}</div>
                                ${payment.originalAmount && payment.originalAmount !== payment.amount ? 
                                    `<div class="text-xs text-gray-500">Original: ‚Çπ${payment.originalAmount.toLocaleString()}</div>` : ''
                                }
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(payment.status)}">
                                ${payment.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="capitalize">${payment.paymentMethod || 'N/A'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatDate(payment.createdAt)}
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full glass-effect border border-blue-100 rounded-lg shadow-lg">
                        <thead class="header-gradient text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Payment ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Workshop</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Method</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-blue-100">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderWorkshopsTable(workshops) {
            if (workshops.length === 0) {
                return renderEmptyState();
            }

            const rows = workshops.map(workshop => `
                <tr class="hover:bg-blue-50/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-lg tab-gradient flex items-center justify-center text-white font-semibold">
                                ${workshop.title.charAt(0)}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${workshop.title}</div>
                                <div class="text-sm text-gray-500">${workshop.slug}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getLevelColor(workshop.level)}">
                            ${workshop.level}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ‚Çπ${(workshop.price || 0).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(workshop.status)}">
                            ${workshop.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${workshop.duration || 0} hours
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatDate(workshop.createdAt)}
                    </td>
                </tr>
            `).join('');

            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full glass-effect border border-blue-100 rounded-lg shadow-lg">
                        <thead class="header-gradient text-white">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Workshop</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Level</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Duration</th>
                                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Created</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-blue-100">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderEmptyState() {
            return `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üì≠</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No data found</h3>
                    <p class="text-gray-600">Try adjusting your search or filter criteria</p>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'active':
                case 'completed':
                    return 'bg-green-100 text-green-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'failed':
                case 'cancelled':
                    return 'bg-red-100 text-red-800';
                case 'draft':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-blue-100 text-blue-800';
            }
        }

        function getLevelColor(level) {
            switch (level) {
                case 'beginner':
                    return 'bg-green-100 text-green-800';
                case 'foundation':
                    return 'bg-blue-100 text-blue-800';
                case 'advanced':
                    return 'bg-purple-100 text-purple-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp.seconds) {
                date = new Date(timestamp.seconds * 1000);
            } else {
                date = new Date(timestamp);
            }
            
            return date.toLocaleDateString();
        }

                 // Live Sessions Tab
         function renderLiveSessionsTab() {
             const liveWorkshops = allData.workshops.filter(w => w.isLiveSession);
             
             if (liveWorkshops.length === 0) {
                 return `
                     <div class="text-center py-12">
                         <div class="text-6xl mb-4">üé•</div>
                         <h3 class="text-lg font-medium text-gray-900 mb-2">No Live Sessions Found</h3>
                         <p class="text-gray-600">No workshops are configured as live sessions yet.</p>
                     </div>
                 `;
             }
             
             const workshopCards = liveWorkshops.map(workshop => {
                 const enrollments = allData.enrollments.filter(e => e.workshopId === workshop.id);
                 const sentEmails = enrollments.filter(e => e.notifications?.liveSessionSent).length;
                 const pendingEmails = enrollments.length - sentEmails;
                 
                 return `
                     <div class="glass-effect rounded-xl shadow-lg p-6 mb-6">
                         <div class="flex items-center justify-between mb-4">
                             <div>
                                 <h3 class="text-xl font-bold text-gray-900">${workshop.title}</h3>
                                 <p class="text-gray-600">${workshop.description || 'No description available'}</p>
                             </div>
                             <div class="text-right">
                                 <div class="text-2xl font-bold text-blue-600">${enrollments.length}</div>
                                 <div class="text-sm text-gray-500">Total Enrollments</div>
                             </div>
                         </div>
                         
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                             <div class="bg-green-50 p-4 rounded-lg">
                                 <div class="text-2xl font-bold text-green-600">${sentEmails}</div>
                                 <div class="text-sm text-green-700">Emails Sent</div>
                             </div>
                             <div class="bg-orange-50 p-4 rounded-lg">
                                 <div class="text-2xl font-bold text-orange-600">${pendingEmails}</div>
                                 <div class="text-sm text-orange-700">Pending Emails</div>
                             </div>
                             <div class="bg-blue-50 p-4 rounded-lg">
                                 <div class="text-2xl font-bold text-blue-600">${workshop.scheduledDate || 'Not Set'}</div>
                                 <div class="text-sm text-blue-700">Scheduled Date</div>
                             </div>
                         </div>
                         
                         <div class="flex flex-wrap gap-2">
                             ${pendingEmails > 0 ? 
                                 `<button onclick="sendBulkEmails('${workshop.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                     üìß Send to ${pendingEmails} Pending Users
                                 </button>` : 
                                 `<div class="px-4 py-2 bg-green-100 text-green-800 rounded-lg">
                                     ‚úÖ All emails sent
                                 </div>`
                             }
                             <button onclick="viewEnrollmentDetails('${workshop.id}')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                 üë• View Details
                             </button>
                             ${!workshop.scheduledDate ? 
                                 `<button onclick="setWorkshopDate('${workshop.id}')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                     üìÖ Set Date
                                 </button>` : ''
                             }
                         </div>
                     </div>
                 `;
             }).join('');
             
             return `
                 <div>
                     <div class="mb-6">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">üé• Live Session Management</h2>
                         <p class="text-gray-600">Manage live session notifications and track email delivery status.</p>
                     </div>
                     ${workshopCards}
                 </div>
             `;
         }
         
         // View enrollment details for a workshop
         function viewEnrollmentDetails(workshopId) {
             const workshop = allData.workshops.find(w => w.id === workshopId);
             const enrollments = allData.enrollments.filter(e => e.workshopId === workshopId);
             const users = allData.users;
             
             const enrollmentRows = enrollments.map(enrollment => {
                 const user = users.find(u => u.id === enrollment.userId);
                 const userName = user ? (user.displayName || user.email || 'Unknown User') : 'Unknown User';
                 const userEmail = user ? user.email : 'N/A';
                 const emailSent = enrollment.notifications?.liveSessionSent;
                 
                 return `
                     <tr class="hover:bg-blue-50/50 transition-colors">
                         <td class="px-6 py-4 whitespace-nowrap">
                             <div class="flex items-center">
                                 <div class="h-8 w-8 rounded-full tab-gradient flex items-center justify-center text-white font-semibold text-xs">
                                     ${userName.charAt(0).toUpperCase()}
                                 </div>
                                 <div class="ml-3">
                                     <div class="text-sm font-medium text-gray-900">${userName}</div>
                                     <div class="text-xs text-gray-500">${userEmail}</div>
                                 </div>
                             </div>
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${formatDate(enrollment.enrolledAt)}
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap">
                             ${emailSent ? 
                                 `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                     ‚úÖ Sent: ${formatDate(emailSent)}
                                 </span>` :
                                 `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                     ‚è≥ Pending
                                 </span>`
                             }
                         </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                             ${emailSent ? 
                                 `<button onclick="resendEmail('${enrollment.id}', '${userEmail}', '${userName}', '${workshopId}')" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                     üîÑ Resend
                                 </button>` :
                                 `<button onclick="sendLiveSessionNotification('${enrollment.id}', '${userEmail}', '${userName}', '${workshopId}')" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                                     üìß Send
                                 </button>`
                             }
                         </td>
                     </tr>
                 `;
             }).join('');
             
             const modalContent = `
                 <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                     <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-hidden">
                         <div class="header-gradient text-white p-6">
                             <div class="flex items-center justify-between">
                                 <h3 class="text-xl font-bold">Enrollment Details - ${workshop.title}</h3>
                                 <button onclick="closeModal()" class="text-white hover:text-gray-200">
                                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                     </svg>
                                 </button>
                             </div>
                         </div>
                         <div class="p-6 overflow-y-auto max-h-[60vh]">
                             <table class="min-w-full">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">User</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Enrolled</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Email Status</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Action</th>
                                     </tr>
                                 </thead>
                                 <tbody class="divide-y divide-gray-200">
                                     ${enrollmentRows}
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             `;
             
             // Add modal to page
             const modalContainer = document.createElement('div');
             modalContainer.id = 'enrollmentModal';
             modalContainer.innerHTML = modalContent;
             document.body.appendChild(modalContainer);
         }
         
         // Close modal
         function closeModal() {
             const modal = document.getElementById('enrollmentModal');
             if (modal) {
                 modal.remove();
             }
         }
         
         // Send bulk emails for a workshop
         async function sendBulkEmails(workshopId) {
             const workshop = allData.workshops.find(w => w.id === workshopId);
             const enrollments = allData.enrollments.filter(e => e.workshopId === workshopId);
             const users = allData.users;
             
             const pendingEnrollments = enrollments.filter(e => !e.notifications?.liveSessionSent);
             
             if (pendingEnrollments.length === 0) {
                 alert('No pending emails to send!');
                 return;
             }
             
             const confirmMessage = `Send live session reminders to ${pendingEnrollments.length} users for "${workshop.title}"?`;
             if (!confirm(confirmMessage)) {
                 return;
             }
             
             let successCount = 0;
             let errorCount = 0;
             
             for (const enrollment of pendingEnrollments) {
                 const user = users.find(u => u.id === enrollment.userId);
                 const userName = user ? (user.displayName || user.email || 'Unknown User') : 'Unknown User';
                 const userEmail = user ? user.email : 'N/A';
                 
                 try {
                     await sendLiveSessionNotification(enrollment.id, userEmail, userName, workshopId, true); // true = bulk mode
                     successCount++;
                 } catch (error) {
                     errorCount++;
                     console.error(`Failed to send email to ${userEmail}:`, error);
                 }
             }
             
                           alert(`Bulk email sending completed!\n‚úÖ Success: ${successCount}\n‚ùå Failed: ${errorCount}`);
              
              // Refresh the current view to show updated status
              renderContent();
         }
         
         // Resend email function
         async function resendEmail(enrollmentId, userEmail, userName, workshopId) {
             const confirmMessage = `Resend live session reminder to ${userName} (${userEmail})?`;
             if (!confirm(confirmMessage)) {
                 return;
             }
             
                           try {
                  await sendLiveSessionNotification(enrollmentId, userEmail, userName, workshopId, false, true); // true = resend mode
                  alert(`‚úÖ Email resent successfully to ${userName} (${userEmail})`);
                  // The renderContent() is already called in sendLiveSessionNotification for non-bulk mode
              } catch (error) {
                  alert(`‚ùå Failed to resend email: ${error.message}`);
              }
         }
         
         // Live session notification functions
         async function sendLiveSessionNotification(enrollmentId, userEmail, userName, workshopId, isBulkMode = false, isResend = false) {
            try {
                const workshop = allData.workshops.find(w => w.id === workshopId);
                if (!workshop || !workshop.isLiveSession || !workshop.scheduledDate) {
                    alert('This workshop is not configured as a live session');
                    return;
                }

                // Show confirmation dialog
                const confirmMessage = `Send live session reminder to ${userName} (${userEmail}) for "${workshop.title}"?`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                // Generate simple email HTML
                const html = `
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <meta charset="utf-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>Live Workshop Reminder - ${workshop.title}</title>
                            <style>
                                body { font-family: Arial, sans-serif; line-height: 1.6; color: #222; background-color: #f4f6fa; margin: 0; padding: 0; }
                                .container { background-color: #fff; padding: 32px 24px; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); max-width: 600px; margin: 40px auto; border: 1px solid #e5e7eb; }
                                .header { text-align: center; margin-bottom: 28px; padding-bottom: 16px; border-bottom: 2px solid #3b82f6; }
                                .logo { font-size: 2.2em; font-weight: bold; color: #3b82f6; margin: 0; letter-spacing: 1px; }
                                .join-button { display: inline-block; padding: 16px 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff !important; text-decoration: none; border-radius: 8px; margin: 20px 0; font-weight: 600; font-size: 1.1em; text-align: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header">
                                    <h1 class="logo">ü¶ã titliAI</h1>
                                    <p style="color: #64748b; margin-top: 6px;">Live Workshop Reminder</p>
                                </div>
                                
                                <h2 style="color: #1e40af; margin-bottom: 16px;">Hello ${userName}!</h2>
                                
                                <p>Your live workshop session is starting soon! We're excited to have you join us for an interactive learning experience.</p>
                                
                                <div style="background-color: #f1f5f9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;">
                                    <h3 style="color: #1e40af; margin-top: 0;">üìö Workshop Details</h3>
                                    <p><strong>Workshop:</strong> ${workshop.title}</p>
                                    <p><strong>Date:</strong> ${workshop.scheduledDate}</p>
                                    <p><strong>Time:</strong> ${workshop.scheduledTime || 'TBD'} (${workshop.timezone || 'IST'})</p>
                                    <p><strong>Duration:</strong> ${workshop.sessionDuration || 120} minutes</p>
                                    <p><strong>Description:</strong> ${workshop.description}</p>
                                </div>
                                
                                ${workshop.meetingLink ? `
                                <div style="background-color: #e0e7ff; padding: 16px; border-radius: 6px; margin: 16px 0; border: 1px solid #c7d2fe;">
                                    <h4 style="color: #3730a3; margin-top: 0;">üîó Meeting Information</h4>
                                    <p><strong>Meeting ID:</strong> ${workshop.meetingId || 'TBD'}</p>
                                    <p><strong>Password:</strong> ${workshop.meetingPassword || 'TBD'}</p>
                                    <p><strong>Direct Link:</strong> <a href="${workshop.meetingLink}" style="color: #3b82f6;">Click here to join</a></p>
                                </div>
                                ` : ''}
                                
                                <p><strong>Please join 5-10 minutes before the scheduled time to ensure everything is working properly.</strong></p>
                                
                                ${workshop.meetingLink ? `
                                <div style="text-align: center;">
                                    <a href="${workshop.meetingLink}" class="join-button">üé• Join Live Workshop</a>
                                </div>
                                ` : ''}
                                
                                <div style="background-color: #f0f9ff; padding: 16px; border-radius: 6px; margin: 20px 0; border: 1px solid #bae6fd;">
                                    <h4 style="color: #0369a1; margin-top: 0;">üìã Preparation Checklist</h4>
                                    <ul style="color: #0369a1; margin: 8px 0;">
                                        <li>‚úÖ Test your microphone and camera</li>
                                        <li>‚úÖ Ensure stable internet connection</li>
                                        <li>‚úÖ Have your questions ready</li>
                                        <li>‚úÖ Find a quiet environment</li>
                                    </ul>
                                </div>
                                
                                <p>If you have any technical issues or questions, please contact us at <strong>support@titliai.com</strong>.</p>
                                
                                <div style="margin-top: 32px; padding-top: 18px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 13px; color: #64748b;">
                                    <p>Best regards,<br><strong>The titliAI Team</strong></p>
                                    <p>This is an automated reminder. Please do not reply to this email.</p>
                                </div>
                            </div>
                        </body>
                    </html>
                `;

                // Send email
                const subject = `üéØ Live Workshop Reminder - ${workshop.title}`;
                
                const response = await fetch('http://localhost:3000/api/email/live-session-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: userEmail,
                        subject: subject,
                        html: html,
                        workshopId: workshop.id,
                        enrollmentId: enrollmentId,
                        notificationType: 'manual'
                    })
                });

                                 if (response.ok) {
                     const result = await response.json();
                     
                     // Update enrollment with notification tracking
                     const enrollmentRef = firebase.firestore().collection('enrollments').doc(enrollmentId);
                     await enrollmentRef.update({
                         'notifications.liveSessionSent': new Date(),
                         'notifications.lastUpdated': new Date()
                     });
                     
                     // Update local data to reflect the change immediately
                     const enrollmentIndex = allData.enrollments.findIndex(e => e.id === enrollmentId);
                     if (enrollmentIndex !== -1) {
                         if (!allData.enrollments[enrollmentIndex].notifications) {
                             allData.enrollments[enrollmentIndex].notifications = {};
                         }
                         allData.enrollments[enrollmentIndex].notifications.liveSessionSent = new Date();
                         allData.enrollments[enrollmentIndex].notifications.lastUpdated = new Date();
                     }
                     
                     if (!isBulkMode) {
                         alert(`‚úÖ Live session reminder sent successfully to ${userName} (${userEmail})`);
                         // Refresh the current view to show updated status
                         renderContent();
                     }
                     console.log(`‚úÖ Email sent successfully to ${userEmail}`);
                     
                     return result;
                 } else {
                     const errorMessage = `‚ùå Failed to send email to ${userEmail}`;
                     if (!isBulkMode) {
                         alert(errorMessage);
                     }
                     console.error(errorMessage);
                     throw new Error(errorMessage);
                 }

            } catch (error) {
                console.error('Error sending live session notification:', error);
                alert(`Error sending notification: ${error}`);
            }
        }

        async function setWorkshopDate(workshopId) {
            try {
                const workshop = allData.workshops.find(w => w.id === workshopId);
                if (!workshop) {
                    alert('Workshop not found');
                    return;
                }

                // Get current date and time for default values
                const now = new Date();
                const defaultDate = now.toISOString().split('T')[0]; // YYYY-MM-DD format
                const defaultTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                // Prompt for date and time
                const scheduledDate = prompt(`Set scheduled date for "${workshop.title}" (YYYY-MM-DD):`, defaultDate);
                if (!scheduledDate) return;

                const scheduledTime = prompt(`Set scheduled time (HH:MM):`, defaultTime);
                if (!scheduledTime) return;

                const timezone = prompt(`Set timezone (e.g., Asia/Kolkata):`, 'Asia/Kolkata');
                if (!timezone) return;

                const sessionDuration = prompt(`Set session duration in minutes:`, '120');
                if (!sessionDuration) return;

                // Validate date format
                if (!/^\d{4}-\d{2}-\d{2}$/.test(scheduledDate)) {
                    alert('Invalid date format. Please use YYYY-MM-DD');
                    return;
                }

                // Validate time format
                if (!/^\d{2}:\d{2}$/.test(scheduledTime)) {
                    alert('Invalid time format. Please use HH:MM');
                    return;
                }

                // Update workshop in Firestore
                const workshopRef = firebase.firestore().collection('workshops').doc(workshopId);
                await workshopRef.update({
                    scheduledDate: scheduledDate,
                    scheduledTime: scheduledTime,
                    timezone: timezone,
                    sessionDuration: parseInt(sessionDuration),
                    updatedAt: new Date()
                });

                alert(`‚úÖ Scheduled date set for "${workshop.title}": ${scheduledDate} at ${scheduledTime} (${timezone})`);
                
                // Refresh data
                await loadData();

            } catch (error) {
                console.error('Error setting workshop date:', error);
                alert(`Error setting date: ${error}`);
            }
        }

                 // Debug function to check enrollment notifications
         function debugEnrollmentNotifications() {
             console.log('üîç Debugging enrollment notifications...');
             allData.enrollments.forEach(enrollment => {
                 console.log(`Enrollment ${enrollment.id}:`, {
                     notifications: enrollment.notifications,
                     hasLiveSessionSent: !!enrollment.notifications?.liveSessionSent,
                     liveSessionSentDate: enrollment.notifications?.liveSessionSent
                 });
             });
         }

         // Upload Workshop Functions
         function renderUploadWorkshopTab() {
             return `
                 <div class="space-y-6">
                     <div class="text-center">
                         <h2 class="text-2xl font-bold text-gray-900 mb-2">üì§ Upload Workshop from Excel</h2>
                         <p class="text-gray-600">Upload new workshop documents to Firestore database using Excel files</p>
                     </div>

                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <!-- Upload Section -->
                         <div class="glass-effect rounded-xl shadow-lg p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÅ Upload Excel File</h3>
                             
                             <div class="space-y-4">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700 mb-2">
                                         Select Excel File (.xlsx)
                                     </label>
                                     <input
                                         type="file"
                                         id="workshopFile"
                                         accept=".xlsx,.xls"
                                         class="w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                     />
                                 </div>
                                 
                                 <button
                                     onclick="uploadWorkshopFile()"
                                     class="w-full tab-gradient text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition-all"
                                 >
                                     üì§ Upload Workshop
                                 </button>
                             </div>

                             <div id="uploadStatus" class="mt-4 hidden">
                                 <div id="uploadProgress" class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                     <div id="uploadProgressBar" class="tab-gradient h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                 </div>
                                 <p id="uploadMessage" class="text-sm text-gray-600"></p>
                             </div>
                         </div>

                         <!-- Template Download Section -->
                         <div class="glass-effect rounded-xl shadow-lg p-6">
                             <h3 class="text-lg font-semibold text-gray-900 mb-4">üìã Get Excel Template</h3>
                             
                             <div class="space-y-4">
                                 <p class="text-sm text-gray-600">
                                     Download the Excel template with the correct structure for workshop upload.
                                 </p>
                                 
                                 <button
                                     onclick="downloadWorkshopTemplate()"
                                     class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-all"
                                 >
                                     üì• Download Template
                                 </button>
                             </div>

                                                           <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                                  <h4 class="font-semibold text-blue-900 mb-2">üìã Key Features:</h4>
                                  <ul class="text-sm text-blue-800 space-y-1">
                                      <li>‚Ä¢ <strong>Create New Workshops</strong> - Add new workshop documents</li>
                                      <li>‚Ä¢ <strong>Update Existing Workshops</strong> - Modify existing workshop data</li>
                                      <li>‚Ä¢ <strong>Complete Structure</strong> - All fields from existing workshops</li>
                                      <li>‚Ä¢ <strong>Complex Curriculum</strong> - Full module and lesson structure</li>
                                      <li>‚Ä¢ <strong>Live Session Support</strong> - Meeting details and scheduling</li>
                                      <li>‚Ä¢ <strong>SEO Metadata</strong> - Meta titles, descriptions, keywords</li>
                                  </ul>
                              </div>
                         </div>
                     </div>

                     <!-- Instructions Section -->
                     <div class="glass-effect rounded-xl shadow-lg p-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">üìñ Instructions</h3>
                         
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                           <div>
                                  <h4 class="font-semibold text-gray-900 mb-2">1. Prepare Excel File</h4>
                                  <ul class="text-sm text-gray-600 space-y-1">
                                      <li>‚Ä¢ Download the template using the button above</li>
                                      <li>‚Ä¢ Fill in all required fields (title, description, price, etc.)</li>
                                      <li>‚Ä¢ For curriculum, use the JSON format provided in the template</li>
                                      <li>‚Ä¢ To update existing workshops, use the same ID (e.g., 'advanced-workshop')</li>
                                      <li>‚Ä¢ Save as .xlsx format</li>
                                  </ul>
                              </div>
                              
                              <div>
                                  <h4 class="font-semibold text-gray-900 mb-2">2. Upload Process</h4>
                                  <ul class="text-sm text-gray-600 space-y-1">
                                      <li>‚Ä¢ Select your prepared Excel file</li>
                                      <li>‚Ä¢ Click "Upload Workshop" button</li>
                                      <li>‚Ä¢ Monitor progress in the status bar</li>
                                      <li>‚Ä¢ Review results in the "Recent Uploads" section</li>
                                      <li>‚Ä¢ Check the Workshops tab to see your changes</li>
                                  </ul>
                              </div>
                         </div>
                     </div>

                     <!-- Recent Uploads Section -->
                     <div class="glass-effect rounded-xl shadow-lg p-6">
                         <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Recent Uploads</h3>
                         <div id="recentUploads" class="text-sm text-gray-600">
                             No recent uploads. Upload your first workshop to see results here.
                         </div>
                     </div>
                 </div>
             `;
         }

         async function uploadWorkshopFile() {
             const fileInput = document.getElementById('workshopFile');
             const file = fileInput.files[0];
             
             if (!file) {
                 alert('Please select an Excel file first');
                 return;
             }
             
             showUploadStatus(true, 'Reading Excel file...', 10);
             
             try {
                 // Read the Excel file using SheetJS
                 const arrayBuffer = await file.arrayBuffer();
                 const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                 const sheetName = workbook.SheetNames[0];
                 const worksheet = workbook.Sheets[sheetName];
                 const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                 
                 if (data.length < 2) {
                     throw new Error('Excel file must have at least a header row and one data row');
                 }
                 
                 const headers = data[0];
                 const rows = data.slice(1);
                 
                 showUploadStatus(true, `Processing ${rows.length} workshops...`, 30);
                 
                 let successCount = 0;
                 let errorCount = 0;
                 const errors = [];
                 
                 for (let i = 0; i < rows.length; i++) {
                     const row = rows[i];
                     const progress = 30 + ((i + 1) / rows.length) * 60;
                     
                     document.getElementById('uploadProgressBar').style.width = progress + '%';
                     
                                           try {
                          // Convert row to workshop object
                          const workshop = {};
                          headers.forEach((header, index) => {
                              if (row[index] !== undefined && row[index] !== null) {
                                  workshop[header] = row[index];
                              }
                          });
                          
                          // Validate and process workshop
                          const { processed, isUpdate } = await processWorkshopData(workshop);
                          
                          // Upload to Firestore using existing Firebase instance
                          const workshopId = processed.id;
                          const workshopRef = firebase.firestore().collection('workshops').doc(workshopId);
                          
                          if (isUpdate) {
                              await workshopRef.update(processed);
                          } else {
                              await workshopRef.set(processed);
                          }
                          
                          successCount++;
                          const action = isUpdate ? 'Updated' : 'Created';
                          showUploadStatus(true, `${action} ${i + 1}/${rows.length} workshops...`, progress);
                          
                      } catch (error) {
                          errorCount++;
                          errors.push(`Row ${i + 2}: ${error.message}`);
                          console.error(`Error processing row ${i + 2}:`, error);
                      }
                 }
                 
                                   const result = {
                      success: true,
                      uploadedCount: successCount,
                      errorCount,
                      errors,
                      totalProcessed: rows.length,
                      timestamp: new Date().toISOString()
                  };
                  
                  const actionText = successCount === 1 ? 'workshop' : 'workshops';
                  showUploadStatus(true, `‚úÖ Successfully processed ${successCount} ${actionText}!`, 100);
                  updateRecentUploads(result);
                 
                 // Refresh workshops data
                 await loadData();
                 
                 // Clear file input
                 fileInput.value = '';
                 
                 setTimeout(() => {
                     showUploadStatus(false);
                 }, 3000);
                 
             } catch (error) {
                 console.error('Upload error:', error);
                 showUploadStatus(true, `‚ùå Upload failed: ${error.message}`, 0);
                 
                 setTimeout(() => {
                     showUploadStatus(false);
                 }, 5000);
             }
         }

                   async function processWorkshopData(workshop) {
              // Required fields validation
              const requiredFields = ['title', 'description', 'price', 'duration', 'level'];
              for (const field of requiredFields) {
                  if (!workshop[field]) {
                      throw new Error(`Missing required field: ${field}`);
                  }
              }
              
              // Check if workshop already exists
              const existingWorkshop = allData.workshops.find(w => w.id === workshop.id);
              const isUpdate = !!existingWorkshop;
              
              // Data type conversions
              const processed = {
                  ...workshop,
                  price: parseFloat(workshop.price) || 0,
                  duration: parseInt(workshop.duration) || 0,
                  featured: workshop.featured === 'true' || workshop.featured === true,
                  isLiveSession: workshop.isLiveSession === 'true' || workshop.isLiveSession === true,
                  maxParticipants: parseInt(workshop.maxParticipants) || 20,
                  sessionDuration: parseInt(workshop.sessionDuration) || 120,
                  updatedAt: new Date()
              };
              
              // Handle curriculum JSON
              if (workshop.curriculum && typeof workshop.curriculum === 'string') {
                  try {
                      processed.curriculum = JSON.parse(workshop.curriculum);
                  } catch (e) {
                      throw new Error(`Invalid curriculum JSON format: ${e.message}`);
                  }
              }
              
              // Handle keywords array
              if (workshop.keywords && typeof workshop.keywords === 'string') {
                  try {
                      processed.keywords = JSON.parse(workshop.keywords);
                  } catch (e) {
                      // If not valid JSON, split by comma
                      processed.keywords = workshop.keywords.split(',').map(k => k.trim());
                  }
              }
              
              // Set createdAt only for new workshops
              if (!isUpdate) {
                  processed.createdAt = new Date();
                  if (!processed.id) {
                      processed.id = generateWorkshopId();
                  }
              } else {
                  // Keep existing createdAt for updates
                  processed.createdAt = existingWorkshop.createdAt;
              }
              
              return { processed, isUpdate };
          }

         function generateWorkshopId() {
             return 'workshop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
         }

                   function downloadWorkshopTemplate() {
              // Create comprehensive template based on existing workshop structure
              const templateData = [
                  {
                      // Basic Information
                      id: 'new-workshop-1',
                      title: 'New AI Workshop',
                      description: 'Comprehensive description of the workshop covering all key topics and learning objectives.',
                      overview: 'Brief overview of what students will learn in this workshop.',
                      level: 'beginner',
                      price: 2999,
                      currency: 'INR',
                      duration: 20,
                      format: 'Online Interactive',
                      certificate: 'true',
                      status: 'active',
                      featured: 'false',
                      slug: 'new-workshop-1',
                      
                      // Live Session Information
                      isLiveSession: 'false',
                      maxParticipants: 20,
                      meetingId: '',
                      meetingLink: '',
                      meetingPassword: '',
                      scheduledDate: '',
                      scheduledTime: '',
                      sessionDuration: 120,
                      timezone: 'Asia/Kolkata',
                      
                      // SEO and Metadata
                      metaTitle: 'New AI Workshop - Learn AI Fundamentals',
                      metaDescription: 'Master AI fundamentals with our comprehensive workshop designed for beginners.',
                      keywords: 'AI, machine learning, artificial intelligence, workshop, online course',
                      
                      // Media URLs
                      thumbnail: '',
                      banner: '',
                      videoPreview: '',
                      
                      // Complex Curriculum Structure (JSON format)
                      curriculum: JSON.stringify({
                          overview: 'Comprehensive curriculum covering all essential AI topics',
                          modules: [
                              {
                                  id: 'module-1',
                                  title: 'Introduction to AI',
                                  description: 'Learn the fundamentals of artificial intelligence',
                                  duration: 2,
                                  lessons: [
                                      {
                                          id: 'lesson-1-1',
                                          title: 'What is AI?',
                                          description: 'Understanding artificial intelligence basics',
                                          duration: 30,
                                          content: 'Detailed lesson content explaining AI concepts',
                                          videoUrl: 'https://example.com/video-1-1',
                                          resources: ['AI_Basics.pdf', 'Introduction_Guide.pdf']
                                      },
                                      {
                                          id: 'lesson-1-2',
                                          title: 'History of AI',
                                          description: 'Evolution of artificial intelligence',
                                          duration: 45,
                                          content: 'Comprehensive history of AI development',
                                          videoUrl: 'https://example.com/video-1-2',
                                          resources: ['AI_History.pdf', 'Timeline.pdf']
                                      }
                                  ]
                              },
                              {
                                  id: 'module-2',
                                  title: 'Practical Applications',
                                  description: 'Real-world AI applications and use cases',
                                  duration: 3,
                                  lessons: [
                                      {
                                          id: 'lesson-2-1',
                                          title: 'AI in Daily Life',
                                          description: 'How AI impacts our everyday activities',
                                          duration: 40,
                                          content: 'Exploring AI applications in daily life',
                                          videoUrl: 'https://example.com/video-2-1',
                                          resources: ['Daily_AI.pdf', 'Applications.pdf']
                                      }
                                  ]
                              }
                          ]
                      }, null, 2)
                  },
                  {
                      // Example of updating existing workshop
                      id: 'advanced-workshop',
                      title: 'Advanced AI Workshop (Updated)',
                      description: 'Updated description for the advanced workshop with new content.',
                      overview: 'Updated overview for advanced AI concepts.',
                      level: 'advanced',
                      price: 5999,
                      currency: 'INR',
                      duration: 16,
                      format: 'Online Interactive',
                      certificate: 'true',
                      status: 'active',
                      featured: 'true',
                      slug: 'advanced',
                      isLiveSession: 'false',
                      maxParticipants: 20,
                      meetingId: '555666777',
                      meetingLink: 'https://zoom.us/j/555666777',
                      meetingPassword: 'titliAI2024',
                      scheduledDate: '2024-01-30',
                      scheduledTime: '16:00',
                      sessionDuration: 240,
                      timezone: 'Asia/Kolkata',
                      metaTitle: 'Advanced AI Workshop - Expert Level Training',
                      metaDescription: 'Master advanced AI techniques with our expert-level workshop.',
                      keywords: 'advanced AI, RAG, vector databases, production deployment',
                      thumbnail: '',
                      banner: '',
                      videoPreview: '',
                      curriculum: JSON.stringify({
                          overview: 'Advanced AI techniques including RAG, vector databases, and production deployment',
                          modules: [
                              {
                                  id: 'module-1',
                                  title: 'Advanced AI Fundamentals',
                                  description: 'Deep dive into advanced AI concepts',
                                  duration: 2,
                                  lessons: [
                                      {
                                          id: 'lesson-1-1',
                                          title: 'Advanced Machine Learning',
                                          description: 'Advanced ML techniques and algorithms',
                                          duration: 60,
                                          content: 'Comprehensive coverage of advanced ML concepts',
                                          videoUrl: 'https://example.com/advanced-ml',
                                          resources: ['Advanced_ML.pdf', 'Algorithms.pdf']
                                      }
                                  ]
                              }
                          ]
                      }, null, 2)
                  }
              ];

             // Create Excel workbook using SheetJS
             const ws = XLSX.utils.json_to_sheet(templateData);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, 'Workshops');
             
             // Download as .xlsx file
             XLSX.writeFile(wb, 'workshop-upload-template.xlsx');

             alert('‚úÖ Excel template downloaded! Fill in your workshop data and upload.');
         }

         function showUploadStatus(show, message = '', progress = 0) {
             const statusDiv = document.getElementById('uploadStatus');
             const progressBar = document.getElementById('uploadProgressBar');
             const messageEl = document.getElementById('uploadMessage');

             if (show) {
                 statusDiv.classList.remove('hidden');
                 progressBar.style.width = `${progress}%`;
                 messageEl.textContent = message;
             } else {
                 statusDiv.classList.add('hidden');
                 progressBar.style.width = '0%';
                 messageEl.textContent = '';
             }
         }

                   function updateRecentUploads(result) {
              const recentUploadsDiv = document.getElementById('recentUploads');
              const timestamp = new Date(result.timestamp).toLocaleString();
              
              const uploadInfo = `
                  <div class="p-3 bg-green-50 border border-green-200 rounded-lg mb-2">
                      <div class="flex justify-between items-center">
                          <span class="text-green-800 font-medium">‚úÖ Workshop Processing Successful</span>
                          <span class="text-xs text-green-600">${timestamp}</span>
                      </div>
                      <div class="text-sm text-green-700 mt-1">
                          <p><strong>Processed:</strong> ${result.uploadedCount} workshop(s)</p>
                          <p><strong>Total Rows:</strong> ${result.totalProcessed}</p>
                          ${result.errorCount > 0 ? `<p><strong>Errors:</strong> ${result.errorCount}</p>` : '<p><strong>Status:</strong> All workshops processed successfully</p>'}
                      </div>
                      ${result.errors && result.errors.length > 0 ? `
                          <details class="mt-2">
                              <summary class="text-sm text-red-600 cursor-pointer font-medium">üìã View Error Details (${result.errors.length})</summary>
                              <ul class="text-xs text-red-600 mt-1 space-y-1 bg-red-50 p-2 rounded">
                                  ${result.errors.map(error => `<li>‚Ä¢ ${error}</li>`).join('')}
                              </ul>
                          </details>
                      ` : ''}
                      <div class="mt-2 text-xs text-green-600">
                          <p>‚úÖ Workshop documents have been successfully saved to Firestore database.</p>
                          <p>üîÑ You can now view them in the Workshops tab or refresh the page to see updates.</p>
                      </div>
                  </div>
              `;
              
              recentUploadsDiv.innerHTML = uploadInfo + recentUploadsDiv.innerHTML;
          }
         
         // Initialize with analytics tab
         document.addEventListener('DOMContentLoaded', function() {
             if (sessionStorage.getItem('adminAuthenticated') === 'true') {
                 switchTab('analytics');
             }
         });
    </script>
</body>
</html>
